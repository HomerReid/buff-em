\documentclass[letterpaper]{article}

\input{physcmds}

\graphicspath{{figures/}}
\newcommand{\TInv}{\rotatebox[origin=c]{180}{$T$}}
\newcommand{\vbTInv}{\rotatebox[origin=c]{180}{$\vb T$}}
\newcommand{\vbTInvSmall}{\rotatebox[origin=c]{180}{\scriptsize{$\vb T$}}}
\newcommand{\bbTInv}{\rotatebox[origin=c]{180}{$\mathbb{T}$}}
\newcommand{\bbVInv}{\rotatebox[origin=c]{180}{$\mathbb{V}$}}

%------------------------------------------------------------
%------------------------------------------------------------
%- Special commands for this document -----------------------
%------------------------------------------------------------
%------------------------------------------------------------
\newcommand{\vbxi}{\boldsymbol{\xi}}
\newcommand{\TT}{\mathbb{T}}
\newcommand{\GG}{\mathbb{G}}
\newcommand{\im}{\text{Im }}
\newcommand{\vbeps}{\boldsymbol{\epsilon}}
\newcommand{\vbLambda}{\boldsymbol{\Lambda}}

%------------------------------------------------------------
%------------------------------------------------------------
%- Document header  -----------------------------------------
%------------------------------------------------------------
%------------------------------------------------------------
\title { {\sc buff-em}: A Volume-Integral-Equation
         Solver Suite for Computational Fluctuation Physics}
\author {Homer Reid}
\date {June 3, 2014}

%------------------------------------------------------------
%------------------------------------------------------------
%- Start of actual document
%------------------------------------------------------------
%------------------------------------------------------------

\begin{document}
\pagestyle{myheadings}
\markright{Homer Reid: \texttt{buff-em} }
\maketitle

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Overview}
\label{OverviewSection}

The MIT Casimir theory group, led by Professors Kardar and 
Jaffe, has derived a number of formulas expressing
Casimir forces (both equilibrium and non-equilibrium) and
rates of heat transfer among a collection of material bodies 
in terms of the $\TT$ and $\GG$ operators of the bodies
\cite{Rahi2009, Kruger2012}.
Although the formulas are expressed as traces of 
certain linear-algebraic combinations of the operators 
and are are thus---in principle---basis-independent, in 
practice the definition of the $\mathbb{T}$ operator is so
unwieldy in the position-space basis that to date the formulas 
have only ever been applied to certain high-symmetry geometries, 
in which the known special forms of the Maxwell solutions allow
analytical evaluation of $\mathbb{T}$-matrix elements in
special bases (such as spherical wave functions for spherical
scatterers).
In effect, this amounts to working in a basis of globally-defined
wave functions, which are typically specific to the 
particular shapes of the objects in question and thus not 
amenable to the treatment of more general geometries.
In particular, to date there has been no obvious way to use
$\mathbb{T}/\mathbb{G}$ formulas to handle \textit{inhomogeneous}
bodies with continuously varying material properties, since 
the $\mathbb{T}$-matrices cannot be computed analytically
for such bodies even if their shapes are highly symmetric.

Here I show that in fact the restriction to special-function
bases is in fact unnecessary, and that, indeed, it is possible
to compute $\mathbb{T}$-matrices \textit{numerically} for
arbitrary inhomogeneous objects using a basis of \textit{localized}
functions. The key observation is that, although it is difficult 
to work with the $\mathbb{T}$ operator in real space, the
$\textit{inverse}$ of this operator has a convenient real-space
description.
This insight leads to a general-purpose approach
that is capable, in principle, of predicting Casimir and
heat-transfer phenomena for bodies of arbitrary shapes and
arbitrary anisotropic continuously-varying material properties.

As it turns out, the inverse $\mathbb{T}$ operator is 
closely related to the matrix that enters the classical
volume-integral-equation (VIE) method of computational 
electromagnetism~\cite{SWG1984}. Thus, the implementation
of a numerical $\mathbb{T}-$matrix-based computation scheme
for fluctuation physics amounts in practice to the 
implementation of a VIE solver. This is the motivation
for {\sc buff-em}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Volume-Integral Scattering Formulation}

\subsection*{Continuous VIE formulation}

Consider a material body with relative permittivity tensor
$\vbeps(\vb x)$ lying in vacuum and irradiated by monochromatic
sources which may lie inside or outside the body. 
Let the electric field due to the sources be $\vb E\sups{inc}$ 
and let $\vb J(\vb x)$ be the induced volume current
density throughout the bulk of the body. 
(We work at frequency $\omega$ and assume time dependence
of all field and currents $\propto e^{-i\omega t}$.)
The total electric field at any point is a sum of
``incident'' and ``scattered'' contributions:\footnote{We
put the terms ``incident'' and ``scattered'' in quotes
to remind readers that the ``incident''-field sources may
in fact lie \textit{inside} the body; in this case it is 
not quite right to refer to the field they produce as 
being ``incident'' on the body, but the terminology is 
convenient nonetheless.}
%====================================================================%
\begin{align}
 \vb E\sups{tot} &= \vb E\sups{inc} + \vb E\sups{scat}
\\
                 &= \vb E\sups{inc} + ikZ_0 \mathbb{G}*\vb J
\label{ETot}
\end{align}
%====================================================================%
where $k=\omega/c$ is the (free-space) wavenumber,
$Z_0=\sqrt{\mu_0/\epsilon_0}$ is the impedance of free space,
$*$ denotes convolution, and $\mathbb{G}$ is the free-space
dyadic Green's function:
$$ \mathbb{G}(\vb x, \vb x^\prime) = 
   \Big(\vb 1 - \frac{1}{k^2} \nabla \times \nabla \Big)
   \frac{e^{ikr}}{4\pi r}
   \qquad (r\equiv |\vb x-\vb x^\prime|).
$$
On the other hand, the induced current is related to the total field
according to
%====================================================================%
\begin{align*}
 \vb J(\vb x) 
&= -i\frac{k}{Z_0} \big[\vbeps(\vb x) - \vb 1\big]\cdot \vb E\sups{tot}(\vb x)
\\
&\equiv -\frac{1}{ikZ_0} \mathbb{V}(\vb x) \cdot \vb E\sups{tot}(\vb x)
\end{align*}
%====================================================================%
where $\mathbb{V}\equiv k^2\big[\vb 1 - \vbeps(\vb x)\big]$ is
sometimes known~\cite{Rahi2009} as the ``potential.''
At points not in free space, i.e. points at which 
$\vbeps(\vb x)\ne \vb 1$, we can invert this equation to read
%====================================================================%
\begin{align}
-ikZ_0 \bbVInv(\vb x) \cdot \vb J(\vb x) &= \vb E\sups{tot}(\vb x)
\nonumber
\intertext{where $\bbVInv\equiv \mathbb{V}^{-1}.$ Now insert (\ref{ETot}):}
-ikZ_0 \bbVInv(\vb x) \cdot \vb J(\vb x) &= \vb E\sups{inc} + ik Z_0 \mathbb{G} \star \vb J \\
\intertext{Rearranging and writing out the convolution, 
           we obtain a volume-integral equation for $\vb J$:} 
  -ikZ_0\left[   \bbVInv(\vb x) \cdot \vb J(\vb x)
              + \int \mathbb{G}(\vb x, \vb x^\prime) 
                \cdot \vb J(\vb x^\prime) \,d\vb x^\prime
        \right]
&= \vb E\sups{inc}(\vb x).
\\
\intertext{In what follows it will be convenient to think of the RHS 
           here as the convolution of just a single operator with $\vb J$:}
 -ikZ_0
  \int \bbTInv(\vb x, \vb x^\prime) \cdot \vb J(\vb x^\prime) \,d\vb x^\prime
&= \vb E\sups{inc}(\vb x).
\label{ContinuousVIE}
\end{align}
where
\numeq{TOperator}
{
  \bbTInv(\vb x, \vb x^\prime) 
  =
  \bbVInv(\vb x) \delta(\vb x-\vb x^\prime)+ \mathbb{G}(\vb x,\vb x^\prime).
}
(The symbol $\bbTInv$ is pronounced ``tee-inverse'' or ``eet''.)

%=================================================
%=================================================
%=================================================
\subsection*{Discretized VIE formulation}

Now let $\vb b_\alpha$ be some convenient set of $N$ vector-valued 
basis functions and approximate $j$ in the form
%====================================================================%
\numeq{JExpansion}
 { \vb J(\vb x) \approx \sum_{\alpha} j_\alpha \vb b_\alpha(\vb x). }
%====================================================================%
Insert into (\ref{ContinuousVIE}) and ``test'' both sides
with the elements of the set $\{\vb b_\alpha\}$ to obtain a
discretized version of (\ref{ContinuousVIE}) in the form of an
$N\times N$ linear system:
%====================================================================%
\numeq{VIESystem}
{
 \vbTInv \cdot \vb j = \vb v
}
%====================================================================%
where the elements of the vector $\vb j$ are the expansion 
coefficients in (\ref{JExpansion}) and the elements of 
$\vbTInv$ and $\vb v$ are 
%====================================================================%
\numeq{Elements}
{
 \TInv_{\alpha\beta}=\exptwoB{\vb b_\alpha}{\bbTInv}{\vb b_\beta},
 \qquad
 v_{\alpha}=-\frac{1}{ikZ_0} \inpB{\vb E\sups{inc}}{\vb b_\beta}.
}
%====================================================================%

\subsubsection*{VIE matrix for geometries containing multiple bodies}

Equation (\ref{VIESystem}) applies to the case in which we 
have only a single material body. For a geometry involving
$N$ separate bodies, this is generalized to read
%====================================================================%
\numeq{VIESystem2}
{
 \underbrace{
 \left(\begin{array}{cccc}
 \vbTInv_1  & \vb U_{12}  & \cdots & \vb U_{1N} \\
 \vb U_{21} & \vbTInv_{2} & \cdots & \vb U_{2N} \\ 
 \vdots     & \vdots      & \ddots & \vdots     \\ 
 \vb U_{N1} & \vb U_{N2}  & \cdots & \vbTInv_N 
 \end{array}\right)
            }_{\vb M}
%--------------------------------------------------------------------%
\left(\begin{array}{c} 
 \vphantom{\vbTInv_1} \vb j_1 \\
 \vphantom{\vbTInv_1} \vb j_2 \\
 \vphantom{\ddots}    \vdots  \\
 \vphantom{\vbTInv_1} \vb j_N \\
\end{array}\right)
%--------------------------------------------------------------------%
 =
\left(\begin{array}{c} 
 \vphantom{\vbTInv_1} \vb v_1 \\
 \vphantom{\vbTInv_1} \vb v_2 \\
 \vphantom{\ddots}    \vdots  \\
 \vphantom{\vbTInv_1} \vb v_N \\
\end{array}\right).
}
%====================================================================%
where $\vb M$ is the VIE matrix for the composite system.
Here the diagonal blocks involve just the matrix elements
of the $\mathbb{T}$-operator [defined by equation (\ref{TOperator})
with the $\bbVInv$ operator appropriate for the $n$th body]
while the off-diagonal blocks involve only the matrix elements of 
the $\mathbb{G}$ operator. 


\subsection*{Symmetries of the VIE matrix}

\subsubsection*{Symmetries of the $\bbVInv$ matrix} 

%====================================================================%
\begin{align}
 \exptwoB{\vb b_\alpha}{\bbVInv}{\vb b_\beta}
&=\frac{1}{k^2} 
   \int \, d\vb x \,
   b_{\alpha i}(\vb x_\alpha) 
   \Big[\vb {1} - \vbeps(\vb x)\Big]^{-1}_{ij}
   b_{\beta j}(\vb x_\beta)
\nn
&=\exptwoB{\vb b_\beta}{\bbVInv}{\vb b_\alpha}
\label{VInvSymmetric}
\intertext{\textbf{if} we have that}
\vbeps &= \vbeps^T \qquad (\textit{not } \vbeps=\vbeps^\dagger!).
\label{EpsSymmetric}
\end{align}

\subsubsection*{Symmetries of the $\mathbb{G}$ matrix} 
%====================================================================%
\begin{align*}
 \exptwoB{\vb b_\alpha}{\mathbb{G}}{\vb b_\beta}
&=\int \, d\vb x_\alpha \, d\vb x_\beta \,
   b_{\alpha i}(\vb x_\alpha) 
   \mathbb{G}_{ij}(\vb x_\alpha-\vb x_\beta)
   b_{\beta j}(\vb x_\beta)
\\
\intertext{Now invoke the relation 
           $\mathbb{G}_{ij}(\vb r) = \mathbb{G}_{ji}(-\vb r):$
          }
&=\int \, d\vb x_\alpha \, d\vb x_\beta \,
   b_{\beta j}(\vb x_\beta)
   \mathbb{G}_{ji}(\vb x_\beta - \vb x_\alpha)
   b_{\alpha i}(\vb x_\alpha) 
\\
&=
 \exptwoB{\vb b_\beta}{\mathbb{G}}{\vb b_\alpha}
\end{align*}
%====================================================================%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{SWG Basis Functions}

SWG basis functions are the three-dimensional analog of
RWG basis functions. They are defined on pairs of adjacent tetrahedra:
%====================================================================%
$$ \vb b_\alpha(\vb x) = 
  \begin{cases}
   \displaystyle{
    +\frac{A_\alpha}{3V_\alpha^+}(\vb x - \vb Q_\alpha^+), 
                }
    \qquad &\vb x\in \mc P_\alpha^+
\\[5pt]
   \displaystyle{
  -\frac{A\alpha}{3V_\alpha^-}(\vb x - \vb Q_\alpha^-), 
                } 
    \qquad &\vb x\in \mc P_\alpha^-
  \end{cases}
$$
%====================================================================%
where $\mc P_\alpha^\pm$ are the two tetrahedra associated with basis
function $\alpha$, $V_\alpha^\pm$ are their volumes, $\vb Q_\alpha\pm$
are the source/sink vertices, and $A_\alpha$ is the area of the 
triangular face shared by $\mc P_\alpha^\pm$. (I denote tetrahedra 
by $\mc P$, which stands for ``pyramid,'' to avoid confusion with
the symbol $\mc T$, which stands for ``triangle'' in my memos on
RWG basis functions.)

The divergence of the SWG basis function is 
%====================================================================%
$$ \nabla \cdot \vb b_\alpha(\vb x) = 
    \pm \frac{A_\alpha}{V_\alpha^\pm}, \qquad \vb x\in \mc P_\alpha^\pm.
$$


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{SWG Matrix Elements of the $\mathbb{G}$ operator}

%=================================================
%=================================================
%=================================================
\subsection{Distant case: Volume-integral method}

The $\mathbb{G}$-matrix element between two SWG basis functions
is
%====================================================================%
\numeq{bGb}
{
 \exptwoB{\vb b_\alpha}{\mathbb G}{\vb b_\beta}
 =\int_{\sup \vb b_\alpha} \, d\vb x_\alpha \,
  \int_{\sup \vb b_\beta} \, d\vb x_\beta\,
   b_{\alpha i}(\vb x_\alpha)
   \mathbb G_{ij}(\vb R_0 + \overline{\vb x}_\alpha - \overline{\vb x}_\beta)
   b_{\beta j}(\vb x_\beta)
}
%====================================================================%
where 
%====================================================================%
$$ \overline{\vb x}_\alpha \equiv \vb x_\alpha - \vb x_{\alpha 0}, 
   \qquad 
   \overline{\vb x}_\beta \equiv \vb x_\beta - \vb x_{\beta 0}, 
   \qquad 
   \vb R_0 = \vb x_{\alpha 0}-\vb x_{\beta 0}
$$
%====================================================================%
and $\vb x_{\alpha 0}, \vb x_{\beta 0}$ are the centroids of
the basis functions.

When the two basis functions are well separated 
(i.e. $|\vb R_0| \gg |\overline{\vb x}_\alpha|, |\overline{\vb x}_\beta|$),
we may compute (\ref{bGb}) to sufficient accuracy using a volume-integral
method in which the 6-dimensional integration over each of the
four pairs of tetrahedra is carried out by simple low-order
numerical cubature.
 
%
%Expand $\mathbb G_{ij}$ about $\vb R_0$:
%%====================================================================%
%\numeq{TaylorExpansion}
%{ \mathbb{G}_{ij}(\vb R_0 + \overline{\vb x}_\alpha - \overline{\vb x}_\beta)
%  \,\approx\, \mathbb{G}_{ij}^0
%         +\overline{x}_{\alpha k} \mathbb{G}_{ijk}^0
%         -\overline{x}_{\beta  k} \mathbb{G}_{ijk}^0
%         +\cdots
%}
%%====================================================================%
%where $\mathbb{G}^0_{ij}\equiv \mathbb{G}_{ij}(\vb R_0)$ 
%and $\mathbb{G}_{ijk}^0\equiv \partial_k \mathbb{G}_{ij}(\vb R_0).$ 
%Equation (\ref{bGb}) then reads (with a summation convention in force)
%%====================================================================%
%\numeq{DQApprox}
%{
% \exptwoB{\vb b_\alpha}{\mathbb G}{\vb b_\beta}
%\approx 
%  \mc J_{\alpha i} \mathbb{G}^0_{ij} \mc J_{\beta j}
% +\mc Q_{\alpha ik} \mathbb{G}^0_{ijk} \mc J_{\beta j}
% -\mc J_{\alpha i} \mathbb{G}^0_{ijk} \mc Q_{\beta jk}
%}
%%====================================================================%
%Here we have introduced the first and second moments
%of the current distributions of the SWG functions:
%\begin{align*}
% \mc J_{\alpha i}
%\equiv \int_{\sup \vb b_\alpha} b_{\alpha i}(\vb x)\,d\vb x
%\\
% \mc Q_{\alpha ij}
%\equiv \int_{\sup \vb b_\alpha} b_{\alpha i}(\vb x) x_j\,d\vb x
%\end{align*}

%=================================================
%=================================================
%=================================================
\subsection{Nearby case: Surface-integral method}
When the basis functions are not well separated, the
dipole/quadrupole expansion method of the previous 
subsection is inaccurate. In this case it is convenient 
to follow the work of Bleszynski et al.~\cite{} by reducing 
the volume integral (\ref{bGb}) to a nonsingular 
\textit{surface} integral:
%====================================================================%
\numeq{GSurfaceIntegral}
{
 \exptwoB{\vb b_\alpha}{\mathbb G}{\vb b_\beta}
=-\frac{1}{4\pi ik} 
  \int_{\partial \sup \vb b_\alpha} \, \!\!\!\!\! d\vb x_\alpha \,
  \int_{\partial \sup \vb b_\alpha} \, \!\!\!\!\! d\vb x_\beta
  \Big(\vbhat{n}_\alpha \cdot \vbhat{n}_\beta\Big)
  \Big[   T_1(\vb x_\alpha, \vb x_\beta)
        + T_2(\vb x_\alpha, \vb x_\beta)
  \Big]
}
%====================================================================%
with
\begin{align*} 
     T_1(\vb x_\alpha, \vb x_\beta) 
  &= \vb b_\alpha(\vb x_\alpha ) \cdot \vb b_\beta(\vb x_\beta)
     h(ik R)
\\
     T_2(\vb x_\alpha, \vb x_\beta) 
  &= -\frac{9A_\alpha A_\beta}{V_\alpha V_\beta k^2}
      \Big\{ 9h(ikR) + w(ikR) 
             +k^2\big[(\vb Q_\alpha - \vb Q_\beta)\cdot \vb R\big]\,p(ikR)
      \Big\}
\end{align*} 
where the scalar functions $h,w,p$ are 
%====================================================================%
\begin{align*}
  h(x) &= \frac{1}{x}\texttt{ExpRelBar}(x,2) \\
  w(x) &= \texttt{ExpRelBar}(x,3) \\
  p(x) &= \frac{1}{x^3}\Big[ x\texttt{ExpRelBar}(x,2) 
                            - \texttt{ExpRelBar}(x,3)\Big] - \frac{1}{3}
\\
       &= \frac{h(x)}{x} - \frac{w(x)}{x^3} - \frac{1}{3}.
\end{align*}
Here the function \texttt{ExpRelBar} is defined by 
\begin{align*}
 \texttt{ExpRelBar}(x,N) 
&= e^{x} - \sum_{n=0}^{N-1} \frac{x^{n}}{N!}
\\
&= \sum_{n=N}^\infty \frac{x^n}{N!}
\end{align*}
I call this \texttt{ExpRelBar} because it is similar to
a similar function known as \texttt{ExpRel} (the two
functions differ only in their normalization).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{Fields of Individual SWG Basis Functions}

Once we have obtained the solution vector $\vb j$ to the 
linear system (\ref{VIESystem}), we can compute the fields
at arbitrary points in space according to 
%====================================================================%
$$ \left\{ \begin{array}{c} \vb E(\vb x) \\ 
                            \vb H(\vb x) 
           \end{array} 
   \right\}
   = 
   \left\{ \begin{array}{c} \vb E\sups{inc}(\vb x) \\ 
                            \vb H\sups{inc}(\vb x) 
           \end{array} 
   \right\}
  + 
  \sum_\alpha j_\alpha
   \left\{ \begin{array}{c} \mathbb{E}_\alpha(\vb x) \\ 
                            \mathbb{H}_\alpha(\vb x)
           \end{array} 
   \right\}
$$
%====================================================================%
where $\{\mathbb{E}_\alpha, \mathbb{H}_\alpha\}$ are the
electric and magnetic fields produced by the current distribution
of basis function $\vb b_\alpha$ populated with unit strength:
%====================================================================%
\begin{align*}
 \mathbb{E}_\alpha(\vb x)
&= ikZ_0 
   \int_{\sup \vb b_\alpha} \mathbb{G}(\vb x, \vb x_\alpha) \cdot \vb b_\alpha
   d\vb x_\alpha
\\
 \mathbb{H}_\alpha(\vb x)
&= 
\end{align*}
%====================================================================%

\subsection*{Distant case: Dipole / Quadrupole approximation}

When the evaluation point is far from the centroid of the basis
function we can use the Taylor expansion (\ref{TaylorExpansion}):
$$
 \mathbb{E}_{\alpha i}(\vb x)
 \approx
 ikZ_0 \Big[   \mathbb{G}^0_{ij} \mc{J}_{\alpha j} 
             - \mathbb{G}^0_{ijk} \mc{Q}_{\alpha jk}
       \Big]
$$
Note the minus sign in the second term.

\subsection*{Nearby case: Surface-integral formulation}

The vector and scalar potentials due to a current distribution
$\vb J$ are 
%====================================================================%
\begin{align*}
 \vb A(\vb x) 
&= 
 \mu_0 \int_{\mc V} \vb J(\vb x^\prime) G_0(\vb r) dV
\\
 \Phi(\vb x)
&= 
 \frac{1}{\epsilon_0} \int_{\mc V} \rho(\vb x^\prime) G_0(\vb r) dV
\\
&= 
 \frac{1}{i\omega \epsilon_0} 
 \int_{\mc V} \Big[\nabla \cdot \vb J\Big] G_0(\vb r) dV
\end{align*}
%====================================================================%
where in the last line we use $\rho = \frac{1}{i\omega}\nabla \cdot \vb J$
and 
$$ G_0(\vb r) = \frac{e^{ik|\vb r|}}{4\pi |\vb r|}
   =\frac{1}{ik}\nabla^2 h(\vb r),
   \qquad 
   \vb 
   r=\vb x-\vb x^\prime.
$$
%====================================================================%
The $\vb E$-field is 
%====================================================================%
$$ \vb E = i\omega\vb A - \nabla \Phi.$$
%====================================================================%
Now putting $\vb J=\vb b_\alpha(\vb x)$ and using $\omega \mu_0 =k Z_0$
and $\omega\epsilon_0=k/Z_0$ we find, for the $\vb E$-field of a
single SWG function
%====================================================================%
\begin{align}
 \mathbb{E}_{\alpha}(\vb x)
&= ikZ_0\left[ \int \vb b_\alpha(\vb x^\prime) G_0(\vb r) d V
              +\frac{1}{k^2}\nabla 
              \int \Big[\nabla \cdot \vb b_\alpha\Big]
                    G_0(\vb r) d\vb x^\prime
        \right].
\label{EAlpha}
\end{align}
%====================================================================%
First integral:
%====================================================================%
\begin{align*}
\int_{\mc V} 
 \vb b_\alpha(\vb x^\prime) G_0(\vb r) dV
&=\sum \pm \frac{A}{3ik V} 
  \int_{\mc V} (\vb x^\prime - \vb Q) 
               \Big[\nabla_{\vb x^\prime}^2 h(\vb r)\Big]
  dV
\intertext{Use (\ref{GreensTheorem}a):}
&= \sum \pm \frac{A}{3ik V} 
    \int_{\partial \mc V} \Big[ (\vb x^\prime - \vb Q)
                       \big[\vbhat{n} \cdot \nabla_{\vb x^\prime} h(\vb r)\big]
                       - \vbhat{n} h(\vb r) 
                 \Big] \, dA
\intertext{Use $\nabla_{\vb x^\prime} h(\vb r) = +k^2 q(\vb r)\,\vb r$:}
&=\sum \pm \frac{A}{3ik V}
    \int_{\partial \mc V} 
    \Big[ (\vb x^\prime - \vb Q)
          k^2 (\vb{r} \cdot \vbhat{n}) q(\vb r)
                        - \vbhat{n} h(\vb r) 
    \Big] \, dA
\end{align*}
%====================================================================%
Second integral:
%====================================================================%
\begin{align*}
\int_{\mc V} \Big[ \nabla \cdot \vb b_\alpha \Big]
             G_0(\vb r) \, dV
&=\sum \pm \frac{A}{ik V} 
   \int_{\mc V} \nabla_{\vb x^\prime}^2 h(\vb r) \, dV
\\
&=\sum \pm \frac{A}{ik V} 
   \int_{\partial \mc V} 
   \nabla_{\vb x \prime} h(\vb r) \cdot \vbhat{n} 
   \, dA
\\
&=-ik\sum \pm \frac{A}{V}
   \int_{\partial \mc V} q(\vb r) (\vb r\cdot \vbhat{n})
   \, dA
\end{align*}
%====================================================================%
The quantity that enters (\ref{EAlpha}) is 
%====================================================================%
\begin{align*}
\frac{1}{k^2} \nabla 
\int_{\mc V} \Big[ \nabla \cdot \vb b_\alpha \Big]
             G_0(\vb r) \, dV
&=\sum \pm \frac{A}{ikV}
  \int_{\partial \mc V}
  \Big[ q(\vb r)\vbhat{n} - k^2 (\vb r\cdot \vbhat{n})t(\vb r) \vb r\Big]
  dA
\end{align*}
%====================================================================%
Putting it all together, the surface integral for the $\vb E$ field
of an individual SWG function is 
%====================================================================%
\begin{align}
 \mathbb{E}_{\alpha}(\vb x)
&=Z_0 \sum \pm \frac{A}{3V} \int_{\partial \mc V}
   \Bigg\{ k^2 (\vb r \cdot \vbhat{n}) q(\vb r) (\vb x^\prime - \vb Q)
          +\big[3q(\vb r) - h(\vb r)\big ]\vbhat{n} 
\nn
&\hspace{2in}
          -3k^2(\vb r \cdot \vbhat{n}) t(\vb r)\vb r
   \Bigg\}dA.
\end{align}
%====================================================================%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newpage
\section{$\mathbb{T}\mathbb{G}$ Formulas
         for Casimir Forces and Heat-Transfer Rates}

\paragraph{Notation}
In the seminal Ref. [Long Matthias paper, PRB 2012], the formulas 
are presented in a somewhat private language that elides the 
distinction between matrices of different dimensions. In particular,
although the quantities $\mathbb{T}_1$ and $\mathbb{T}_2$
in those formulas always correspond to matrices of dimension 
$N_1\times N_1$ and $N_2\times N_2$ (where $N_1$ and $N_2$ 
are the numbers of basis functions allocated to objects 1 and 2), 
the symbol ``1'' refers ambiguously to $N_1\times N_1$ or 
$N_2\times N_2$-dimensional unit matrices, while the symbol
$\mathbb{G}_0$ refers ambiguously to matrices of dimension
$N_1\times N_1$, $N_1\times N_2$, $N_2\times N_1$, or
$N_2\times N_2$. In what follows we attempt to dispel this 
confusion through the use of symbols such as $\vb 1_{N}$ 
for $N\times N$ unit matrices and $\vb U_{ij}$ for 
$N_i\times N_j$ matrix representations of the $\mathbb{G}$ operator.

We also assign shorthand notation to two matrices that appear 
frequently in these formulas:
%====================================================================%
\begin{align*}
\text{``}
 \text{Im }\mathbb{T}_i - 
           \mathbb{T}_i \text{Im}[\mathbb{G}_0]\mathbb{T}_i^*
 \text{''}
&\,\,\equiv\,\, \vb A_i 
 = \text{Im }\vb{T}_i - \vb{T}_i \text{Im}[\vb U_{ii}]\vb{T}_i^\dagger
\\
\text{``}
\frac{1}{1-\mathbb{G}_0 \mathbb{T}_i \mathbb{G}_0 \mathbb{T}_j}
\text{''}
&\,\,\equiv\,\, \vb B_{ij}
= \Big[ \mathbf{1}_{N_j}
         -\vb U_{ji} \vb{T}_i \vb{U}_{ij} \vb T_j
   \Big]^{-1}
\end{align*}
%====================================================================%
Matrices $\vb A_i$ and $\vb B_{ij}$ have dimensions $N_i\times N_i$ 
and $N_j \times N_j$ respectively.

Examples of the Kr\"uger/Kardar/Jaffe formulas that we will use
include
%====================================================================%
\begin{description}
 \item[1.] \textit{Equilibrium Casimir energy between two bodies:}
 \numeq{KJCasimirEnergy}
  {
   \mathcal{E}=\frac{\hbar c}{2\pi}\int
   \log\det\Big(\vb{1} - \vb U_{12}\vb T_2\vb U_{21}\vb T_1\Big)
   d\xi
  }
(where $\xi$ indicates imaginary frequency)
%====================================================================%
 \item[2.] \textit{Rate of heat radiation from a single body:}
%====================================================================%
 $$H=\frac{2}{\pi}
   \int \,\Theta(\omega) \mc{H}(\omega) d\omega
 $$
where $\Theta(\omega)\equiv \frac{\hbar\omega}{e^{\hbar\omega/kT} - 1}$
is the Bose-Einstein factor and $\mc H$ reads, in Kr\"uger language, 
%====================================================================%
$$
  \mc H=
   \text{Tr }\Big[  \text{Im} \big[ \mathbb{G}_0 \big] 
                    \text{Im} \big[ \mathbb{T}_1 \big]
                   -\text{Im} \big[ \mathbb{G}_0 \big]
                    \mathbb{T}_i
                    \text{Im} \big[ \mathbb{G}_0 \big]
                    \mathbb{T}_i^\dagger
             \Big]
 $$
%====================================================================%
or, in our language,
%====================================================================%
$$ \mc H = \text{Tr} \Big[ \text{Im}\big[\vb U_{11}\big] \vb A_{1}\Big].$$
%====================================================================%
 \item[3.] \textit{Heat transfer from body 1 to body 2:}
 $$H_1^{(2)}=\frac{2}{\pi}
   \int \,\Theta(\omega) \mathcal{H}_1^{(2)}(\omega)\,d\omega
 $$
%====================================================================%
where, in Kr\"uger language,
%====================================================================%
\begin{align}
\mathcal{H}_1^{(2)}
&=\text{Im Tr }
   \bigg\{ (1 + \GG \TT_2) \frac{1}{1-\GG \TT_1 \GG \TT_2}
           \GG 
           \Big[ \im \TT_1 - \TT_1 \big(\im \GG\big) \TT_1^\dagger \Big] 
           \GG^\dagger
           \frac{1}{1-\TT_2^\dagger \GG^\dagger \TT_1^\dagger \GG^\dagger}\TT_2^\dagger
   \bigg\}
\nn
%--------------------------------------------------------------------%
\intertext{or, in our language,}
%--------------------------------------------------------------------%
\mathcal{H}_1^{(2)}
&=\text{Im Tr }
   \bigg\{ (\vb 1_{N_2} + \vb U_{22} \vb T_2) \vb B_{12}
           \vb U_{21} \vb A_{1} \vb U_{21}^\dagger
           \vb B_{12}^\dagger \vb T_2^\dagger
   \bigg\}
\end{align}
%====================================================================%
 \item[4.] \textit{ Momentum transfer (Nonequilibrium Casimir force) 
                    from body 1 to body 1 or body 1 to body 2} 
%====================================================================%
 \begin{align*}
   F_1^{(1)}&=\frac{2}{\pi}
   \int \,\Theta(\omega) \mathcal{F}_1^{(1)}(\omega)\,\frac{d\omega}{\omega}
\\
   F_1^{(2)}&=\frac{2}{\pi}
   \int \,\Theta(\omega) \mathcal{F}_1^{(2)}(\omega)\,\frac{d\omega}{\omega}
 \end{align*}
%====================================================================%
In Kr\"uger language,
%====================================================================%
\begin{align*}
 \mathcal{F}_1^{(1)}&=\text{Re Tr }
   \bigg\{ \nabla (1 + \GG \TT_2) 
           \frac{1}{1-\GG \TT_1 \GG \TT_2}
           \GG 
           \Big[ \im \TT_1 - \TT_1 \big(\im \GG\big) \TT_1^\dagger \Big] 
           \frac{1}{1-\GG_0^* \TT_2^* \GG_0^* \TT_1^*}
   \bigg\}
\\
 \mathcal{F}_1^{(2)}&=\text{Re Tr }
   \bigg\{ \nabla (1 + \GG \TT_2) 
           \frac{1}{1-\GG \TT_1 \GG \TT_2}
           \GG 
           \Big[ \im \TT_1 - \TT_1 \big(\im \GG\big) \TT_1^\dagger \Big] 
           \GG^\dagger
           \frac{1}{1-\TT_2^\dagger \GG^\dagger \TT_1^\dagger \GG}
           \TT_2^\dagger
   \bigg\}
\\
\end{align*}
%====================================================================%
\end{description}
%====================================================================%

\subsection*{Equilibrium Casimir force}

Equation (\ref{KJCasimirEnergy}) for the equilibrium Casimir energy 
is the two-body special case of the more general formula
%====================================================================%
\numeq{KJCasimirEnergy2}
{
   \mathcal{E}=\frac{\hbar c}{2\pi}\int
   \log\frac{\det \vb M(\xi)}{\det \vb M_0(\xi)} \, d\xi 
}
where $\vb M(\xi)$ is just the full VIE matrix and $\vb M_0$
is that matrix with the $\vb U$ blocks zeroed out, corresponding
to the case in which all objects are infinitely separated:
%====================================================================%
$$
\vb M(\xi)=
   \left(\begin{array}{cccc}
   \vbTInv_1  & \vb U_{12} & \cdots & \vb U_{1N} \\
   \vb U_{21} & \vbTInv_2  & \cdots & \vb U_{2N} \\
   \vdots     & \vdots     & \ddots & \vdots     \\
   \vb U_{N1} & \vb U_{N2} & \cdots & \vbTInv_{N} 
   \end{array}\right), 
\qquad
\vb M_0(\xi)=
   \left(\begin{array}{cccc}
   \vbTInv_1  & 0          & \cdots & 0          \\
   0          & \vbTInv_2  & \cdots & 0          \\
   \vdots     & \vdots     & \ddots & \vdots     \\
   0          & 0          & \cdots & \vbTInv_{N} 
   \end{array}\right).
$$
%====================================================================%
%====================================================================%
where the matrix is just the full VIE matrix 
Differentiating, we obtain a expression for the Casimir force on 
body $1$:
%====================================================================%
\numeq{KJCasimirForce}
{
   \mathcal{F}_1=\frac{\hbar c}{2\pi}\int
   \text{Tr}\Big\{ \vb M^{-1} 
            \frac{ \partial \vb M}{\partial \vb r_i} 
            \Big\} \, d\xi
}
%====================================================================%
where the derivative is taken with respect to infinitesimal
displacement of object 1 in the $i$th cartesian direction:
%====================================================================%
$$
\frac{ \partial \vb M}{\partial \vb r_i} 
 =
   \left(\begin{array}{cccc}
   0                     & \partial_i \vb U_{12} & \cdots & \partial_i \vb U_{1N} \\
   \partial_i \vb U_{21} & 0                     & \cdots & 0          \\
   \vdots                & \vdots                & \ddots & \vdots     \\
   \partial_i \vb U_{N1} & 0                     & \cdots & 0           
   \end{array}\right),
$$

%====================================================================%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendix 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Volume integrals involving SWG basis functions}

Integrals over the support of SWG basis functions take the form
\numeq{SWGVolumeIntegral}
{
 \int_{\sup \vb b_\alpha} \mathcal{I}(\vb x, \vb b_\alpha) \, d\vb x
= 
  \int_{\mc P_\alpha^+} \mathcal{I}(\vb x, \vb b_\alpha) \, d\vb x
 +\int_{\mc P_\alpha^-} \mathcal{I}(\vb x, \vb b_\alpha) \, d\vb x
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Consider a tetrahedron with vertices 
$\{\vb Q, \vb V_1, \vb V_2, \vb V_3.\}$ 
A general
integral over this region takes the form 
%====================================================================%
\begin{align*}
 \int_{\mc P} \mathcal{I}(\vb x, \vb b ) \, d\vb x
&=\mc{J} \int_0^1 \, du \int_0^{1-u} \, dv \int_0^{1-u-v} dw \,
  \mathcal{I}\Big( \vb x(u,v,w), \vb b(u,v,w) \Big)
\end{align*}
%====================================================================%
%====================================================================%
\begin{align*}
 \vb x(u,v,w) 
&= 
 \vb Q + u\vb L_1 + v\vb L_2 + w\vb L_3 
\\
 \vb b(u,v,w) 
&= 
 \pm \frac{A}{3V}\bigg\{ u \vb L_1 
                        +v \vb L_2 
                        +w \vb L_3 
                 \bigg\}
\end{align*}
%====================================================================%
where
%====================================================================%
$$ \vb L_i \equiv \vb V_i - \vb Q_i $$
%====================================================================%
and the Jacobian of the transformation is 
%====================================================================%
$$\mc J=\frac{d(x,y,z)}{d(u,v,w)}
   =\det\left|\begin{array}{ccc} 
     \\
     \vb L_1 & \vb L_2 & \vb L_3 \\
     \\
     \end{array}\right|
  =6V
$$

%=================================================
%=================================================
%=================================================
\subsection*{Overlap Matrix Elements} 

\begin{align*} 
  \inpB{\vb b_\alpha}{\vb b_\beta}
&=\sum \pm \frac{A_\alpha A_\beta}{9V^2}
  \int_{\mc V} 
  \Big(\vb x-\vb Q_\alpha\Big)
  \cdot
  \Big(\vb x-\vb Q_\beta\Big)
  d\vb x
\intertext{(where the sum is over the 0, 1, or 2 tetrahedra in the 
            common support of $\{\vb b_\alpha,\vb b_\beta\}$)}
&=\sum \pm \frac{2A_\alpha A_\beta}{3V}
  \int_0^1 \, du \int_0^{1-u} \, dv \, \int_0^{1-u-v}\, dw\,
  \bigg\{ 
  \Big[u\vb L_{1\alpha} + v\vb L_{2\alpha} + w\vb L_{3\alpha}\Big]
\\
&\hspace{2in}
  \cdot \Big[u\vb L_{1\alpha} + v\vb L_{2\alpha} + w\vb L_{3\alpha} 
            + \vb Q_\alpha - \vb Q_\beta\Big]
  \bigg\}
\\
&=\sum \pm \frac{2A_\alpha A_\beta}{3V}
  \bigg\{ \frac{1}{120}
          \Big|\vb L_{1\alpha} + \vb L_{2\alpha} + \vb L_{3\alpha}
          \Big|^2
         +\frac{1}{120}\Big( |\vb L_{1\alpha}|^2 
                            +|\vb L_{2\alpha}|^2 
                            +|\vb L_{3\alpha}|^2 \Big)
\\
&\hspace{2in}
         +\frac{1}{24}
         \Big(\vb L_{1\alpha} + \vb L_{2\alpha} + \vb L_{3\alpha}\Big)
          \cdot (\vb Q_\alpha - \vb Q_\beta)
  \bigg\}
\intertext{This can be simplified by noting that 
           $\vb L_{1\alpha} + \vb L_{2\alpha} + \vb L_{3\alpha}
           =3(\vb X_{0\alpha} - \vb Q_\alpha)$
           where $\vb X_{0\alpha}$ is the centroid of 
           basis function $\vb b_\alpha$:}
&=\sum \pm \frac{2A_\alpha A_\beta}{3V}
  \Big[ \frac{3}{40}(\vb X_{0\alpha}-\vb Q_\alpha)^2 
        +\frac{1}{120}\Big( |\vb L_{1\alpha}|^2 
                           +|\vb L_{2\alpha}|^2 
                           +|\vb L_{3\alpha}|^2 \Big)
\\
&\hspace{1.5in}
         +\frac{1}{8}(\vb X_{0\alpha} - \vb Q_\alpha) 
               \cdot (\vb Q_\alpha-\vb Q_\beta)
  \Big].
\end{align*}

%=================================================
%=================================================
%=================================================
\subsection*{Dipole and Quadrupole Moments}

The dipole moment of the current distribution described by
a single unit-strength SWG basis function is 

\numeq{pAlpha}
{
   \vb p_\alpha 
   \equiv 
   \frac{i}{\omega} 
   \underbrace{\int_{\sup \vb b_\alpha} \vb b_\alpha(\vb x) \, d\vb x}
             _{\bmc J_\alpha(\vb x)}
}
%====================================================================%
The Cartesian components of $\bmc J_\alpha(\vb x)$ may be worked out 
in closed form:
%====================================================================%
\begin{align}
 \mc J_{\alpha i}(\vb x)
&=2A\int_0^1 \, du \, \int_0^{1-u} \, dv \, \int_0^{1-u-v}  \, dw \,
    (u+v+w) (\vb Q^- - \vb Q^+)_i
\nn
&=\frac{A}{4} (\vb Q^- - \vb Q^+)_i.
\label{mcJAlpha}
\end{align}
%====================================================================%
Similarly, the quadrupole moments are related to the quantity
\begin{align*}
 \mc Q_{\alpha ij}(\vb x)
&= \int_{\sup \vb b_\alpha} b_{\alpha i} (\vb x-\vb x_0)_j\, d\vb x
\intertext{where $\vb x_0=\frac{1}{3}(\vb V_1 + \vb V_2 + \vb V_3)$
           is the centroid of the basis function (which we take to 
           be the centroid of the triangle that constitutes the 
           common face).}
&=
2A\int_0^1 \, du \, \int_0^{1-u} \, dv \, \int_0^{1-u-v}  \, dw \,
 \bigg\{
\\
&\qquad\qquad 
 \hphantom{-}\,
  \bigg[ u\vb L_1^+ + v\vb L_2^+ + w\vb L_3+ \bigg]_i
  \left[ \left(u-\frac{1}{3}\right)\vb L_1^+
        +\left(v-\frac{1}{3}\right)\vb L_1^+
        +\left(w-\frac{1}{3}\right)\vb L_1^+
  \right]_j
\\
&\qquad\qquad 
 -\bigg[ u\vb L_1^- + v\vb L_2^- + w\vb L_3- \bigg]_i
  \left[ \left(u-\frac{1}{3}\right)\vb L_1^-
        +\left(v-\frac{1}{3}\right)\vb L_2^-
        +\left(w-\frac{1}{3}\right)\vb L_3^-
  \right]_j
 \bigg\}
\\
&=\frac{A}{20}
  \bigg\{ 
          Q^-_i \Big[ \vb Q^- - \vb x_0 \Big]_j
         -Q^+_i \Big[ \vb Q^+ - \vb x_0 \Big]_j
         +x_{0i}\Big[ \vb Q^+ - \vb x_0 \Big]_j
  \bigg\}
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Derivation of Equation (\ref{GSurfaceIntegral})}

Begin by introducing the function
%====================================================================%
\begin{align}
 h(r) &\equiv \frac{e^{ikr} - 1 - ikr}{4\pi ikr}
\intertext{with gradient}
 \nabla_{\vb r} h 
 &= \frac{1+e^{ikr}(-1+ikr)}{4ik\pi r^3} \vb {r}
\intertext{and Laplacian}
 \nabla_{\vb r}^2 h &= 
 ik \cdot \frac{e^{ikr}}{4\pi r}.
\label{DelDelh}
\end{align}
It is convenient to write the gradient of $h$ in the form
%====================================================================%
\begin{align*}
 \nabla_{\vb r} h 
 = -k^2 q(r) \, \vb r, \, 
   \qquad q(r)&\equiv\frac{1+e^{ikr}(-1+ikr)}{4\pi(ikr)^3}.
\\
              &\equiv\frac{e^{ikr}}{4\pi(ikr)^3}\cdot \texttt{ExpRelBar}(-ikr,2)
\end{align*}
and to write the gradient of $q$ in the form
%====================================================================%
\begin{align}
 \nabla_{\vb r} q
 = -k^2 t(r) \, \vb r, \,
   \qquad t(r)&\equiv\frac{-3+e^{ikr}(3-3ikr+(ikr)^2)}{4\pi(ikr)^5}.
\\
              &\equiv-\frac{e^{ikr}}{4\pi(ikr)^5}
               \Big\{     \texttt{ExpRelBar}(-ikr,2) 
                       + 2\texttt{ExpRelBar}(-ikr,3)
               \Big\}.
\end{align}
%====================================================================%
Also useful is
$$ \frac{e^{ik|\vb r|}}{4\pi|\vb r|}
   =\frac{1}{4\pi i k} \nabla_{\vb r} \cdot \vb F(\vb r),
   \qquad
   \vb F(\vb r)= \frac{e^{ikr}(ikr-1) + 1}{r^2} \vb r.
$$

%====================================================================%
We will also need Green's theorem in the forms 
%====================================================================%
\begin{subequations}
\begin{align}
\int_{\mc V} \Big[ \phi\nabla^2 \psi - \psi\nabla^2 \phi\Big] dV
&=
\int_{\partial \mc V} \left(\phi \nabla \psi - \psi\nabla\phi\right)
     \cdot \, d\vb A
\intertext{and}
\int_{\mc V} (\nabla \cdot \vb a) \, dV 
&=
\int_{\partial \mc V} \vb a \cdot \, d\vb A 
\end{align}
\label{GreensTheorem}
\end{subequations}
%====================================================================%
The matrix element of the $\mathbb{G}$ operator between
SWG basis functions is 
%====================================================================%
\begin{align*}
  \exptwoB{\vb b_\alpha}{\mathbb{G}}{\vb b_\beta}
&=
 \int_{\mc V_\alpha}\,d\vb x_\alpha\,
 \int_{\mc V_\beta}\,d\vb x_\beta\,
 \Big[\vb b_\alpha \cdot \vb b_\beta 
          -\frac{ (\nabla \cdot \vb b_\alpha)
                  (\nabla \cdot \vb b_\beta)
                }{k^2}
 \Big] \frac{e^{ik|\vb r|}}{4\pi |\vb r|}
\\
%--------------------------------------------------------------------%
&=-\pf{A_\alpha A_\beta}{9V_\alpha V_\beta k^2} \mathcal{I}_1
  -\pf{A_\alpha A_\beta}{V_\alpha V_\beta k^4} \mathcal{I}_2
\intertext{where}
%--------------------------------------------------------------------%
\mathcal{I}_1
&=
 \int_{\mc V_\alpha}\,d\vb x_\alpha\,
 \int_{\mc V_\beta}\,d\vb x_\beta\,
     P(\vb x_\alpha, \vb x_\beta) 
     \nabla^2_\alpha h(\vb r)
\\
%--------------------------------------------------------------------%
\mathcal{I}_2
&=
 \int_{\mc V_\alpha}\,d\vb x_\alpha\,
 \int_{\mc V_\beta}\,d\vb x_\beta\,
 \nabla_\alpha \nabla_\beta h(\vb r)
\end{align*}
with

$$P(\vb x_\alpha, \vb x_\beta) = 
   (\vb x_\alpha-\vb Q_\alpha)\cdot (\vb x_\beta-\vb Q_\beta),
   \qquad
   \nabla_\alpha \equiv \nabla_{\vb x_\alpha},  
   \qquad
   \nabla_\beta \equiv \nabla_{\vb x_\beta}.
$$
%====================================================================%
First transform the integral in $\mathcal{I}_1$
by using (\ref{GreensTheorem}a) with $\phi=P$, $\psi=h$
and noting that $\nabla_\alpha^2 P=0:$ 
%====================================================================%
\begin{align}
\mathcal{I}_1 
&=
 \int_{\mc V_\beta} \, d\vb x_\beta\,
 \left\{ 
   \int_{\mc V_\alpha}
         P(\vb x_\alpha, \vb x_\beta)
         \nabla_\alpha^2 h(\vb r)
        \, d\vb x_\alpha
 \right\}
\nn
&=
 \int_{\mc V_\beta} \, d\vb x_\beta\,
 \left\{ 
   \int_{\partial \mc V_\alpha}
         \Big[
         P(\vb x_\alpha, \vb x_\beta) \nabla_\alpha h
         - (\vb x_\beta-\vb Q_\beta)h
         \Big] \cdot \vbhat{n_\alpha} \,d\vb x_\alpha
 \right\}
\nn
&=-
 \int_{\mc V_\beta} \, d\vb x_\beta\,
 \left\{ 
   \int_{\partial \mc V_\alpha}
         \Big[
         P(\vb x_\alpha, \vb x_\beta) \nabla_\beta h
         + (\vb x_\beta-\vb Q_\beta)h
         \Big] \cdot \vbhat{n_\alpha} \,d\vb x_\alpha
 \right\}
\intertext{Use $\nabla_\beta\Big[Ph\Big] = P\nabla_\beta h
               +h(\vb x_\alpha-\vb Q_\alpha):$}
&=-
 \int_{\mc V_\beta} \, d\vb x_\beta\,
 \left\{ 
   \int_{\partial \mc V_\alpha}
         \Big[
         \nabla_\beta \Big[Ph\Big] 
         - (\vb x_\alpha-\vb Q_\alpha) h
         + (\vb x_\beta-\vb Q_\beta)h
         \Big] \cdot \vbhat{n_\alpha} \,d\vb x_\alpha
 \right\}
\\
&=-
 \int_{\mc V_\beta} \, d\vb x_\beta\,
 \left\{ 
   \int_{\partial \mc V_\alpha}
         \Big[
         \nabla_\beta \Big[Ph\Big] 
         + (  \vb x_\beta - \vb x_\alpha 
            - \vb Q_\beta - \vb Q_\alpha) h
         \Big] \cdot \vbhat{n_\alpha} \,d\vb x_\alpha
 \right\}
\end{align}
Now use (\ref{GreensTheorem}b) twice to 
transform the second integral in $\mathcal{I}_2$:
\begin{align*}
\mc I_2=
 \int_{\mc V_\alpha} \, d\vb x_\alpha\,
 \nabla_\alpha \cdot 
 \left\{ \int_{\mc V_\beta}  \, d\vb x_\beta\,
         \nabla_\beta h(\vb r)
 \right\}
&=
 \int_{\mc V_\alpha} \, d\vb x_\alpha\,
 \nabla_\alpha \cdot 
 \left\{ \int_{\partial \mc V_\beta} 
         h(\vb r)\vbhat{n}_\beta\, d\vb x_\beta
 \right\}
\\
&=
 \int_{\partial \mc V_\beta} d\vb x_\beta
 \vbhat{n}_\beta \cdot 
 \left\{
 \int_{\mc V_\alpha} 
 \nabla_\alpha h(\vb r)
 \, d\vb x_\alpha\,
 \right\}     
\\
&=
 \int_{\partial \mc V_\alpha} d\vb x_\alpha
 \int_{\partial \mc V_\beta} d\vb x_\beta
 \Big[\vbhat{n}_\alpha \cdot \vbhat{n}_\beta\Big] h(\vb r).
\end{align*}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Diagonal Elements of the $\mathbb{G}$ Matrix}

The diagonal element of the $\mathbb{G}$ matrix is 
%====================================================================%
\numeq{DiagonalElement}
{
   \exptwob{\vb b_\alpha}{\mathbb{G}}{\vb b_\alpha}
= \frac{1}{ikZ_0}\int \vb J^*(\vb x) \cdot \vb E(\vb x) \, d\vb x
}
%====================================================================%
where $\vb J(\vb x)=\vb b_\alpha(\vb x)$ is the current distribution
of a single unit-strength SWG function (note we have $\vb J^*=\vb J$ 
as the SWG basis is real-valued) and
%====================================================================%
$$ \vb E(\vb x) =
   ikZ_0 \int \mathbb{G}(\vb x, \vb x^\prime) 
   \vb b_\alpha(\vb x^\prime) d\vb x^\prime
$$ 
%====================================================================%
is the electric field produced by this same current distribution.

Using Poynting's theorem [see, for example, Jackson equation (6.134)],
we may equate the real part of the RHS of equation 
(\ref{DiagonalElement}) to the negative of the power radiated 
to infinity by the localized current distribution $\vb J(\vb x)$:
%====================================================================%
\begin{align}
 -\frac{1}{2}\text{Re }\int \vb J^* \cdot \vb E \, dV 
&= \text{Re }\oint \vb S \cdot d\vb A 
\nn
&\approx \frac{ c^2 Z_0 k^4}{12\pi} |\vb p|^2
\label{PoyntingTheorem}
\end{align}
%====================================================================%
where on the RHS we have inserted the expression for the total power 
radiated by a point dipole; we expect the approximation to improve as 
the size of the basis function shrinks (so that its current distribution
more closely resembles that of a point dipole). Using equations 
(\ref{pAlpha}), (\ref{DiagonalElement}), and (\ref{PoyntingTheorem})
then allows us to derive the following expected relationship
between the diagonal $\mathbb{G}$-element and the first 
spatial moment of the SWG basis function:
%====================================================================%
\begin{align*}
 \text{Im } \exptwob{\vb b_\alpha}{\mathbb{G}}{\vb b_\alpha}
= \frac{k}{6\pi} \Big|\bmc J_\alpha\Big|^2.
\end{align*} 

%====================================================================%
%====================================================================%
%====================================================================%
\newpage
\bibliographystyle{ieeetr}
\bibliography{buff-em}

\end{document}
